name: Compilar SkyHawk Recovery Project (SHRP)

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: 'URL del Manifiesto de SHRP'
        required: true
        default: 'https://github.com/SHRP/manifest.git'
      manifest_branch:
        description: 'Rama del Manifiesto de SHRP'
        required: true
        default: 'v3_9.0'
      device_tree_url:
        description: 'URL del Device Tree'
        required: true
        default: 'https://github.com/elmendezz/android_device_motorola_pettyl'
      device_branch:
        description: 'Rama del Device Tree (En blanco para main/master)'
        required: false
        default: 'android-8.1'
      device_manufacturer:
        description: 'Fabricante (ej. motorola, xiaomi)'
        required: true
        default: 'motorola'
      device_codename:
        description: 'Nombre clave del dispositivo (ej. pettyl)'
        required: true
        default: 'pettyl'
      build_target:
        description: 'Objetivo de compilaci√≥n (mka recoveryimage)'
        required: true
        default: 'recoveryimage'

permissions:
  contents: write

jobs:
  SHRP-Compile:
    runs-on: ubuntu-22.04 
    
    steps:
    - name: üßπ Limpiar espacio en disco
      uses: jlumbroso/free-disk-space@v1.3.1
      with:
        tool-cache: false
        android: false

    - name: ‚öôÔ∏è Configurar Action y Java
      uses: actions/checkout@v4
    - uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: üöÄ Preparaci√≥n Paralela (Dependencias)
      run: |
        set -e
        trap 'echo "‚ùå ERROR: Fall√≥ la preparaci√≥n en la l√≠nea $LINENO." >&2' ERR
        
        echo "Iniciando descarga de dependencias..."
        
        (sudo apt-get update -qq && sudo apt-get install -y bc bison build-essential curl flex g++-multilib gcc-multilib git gnupg gperf imagemagick lib32ncurses5-dev lib32readline-dev lib32z1-dev liblz4-tool libncurses5 libncurses5-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils lzop pngcrush rsync schedtool squashfs-tools xsltproc zip zlib1g-dev python2) &
        PID_APT=$!
        
        (sudo curl -sL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo && sudo chmod a+rx /usr/local/bin/repo) &
        PID_REPO=$!
        
        (mkdir -p $HOME/bin && ln -s /usr/bin/python2 $HOME/bin/python) &
        PID_PY=$!
        
        wait $PID_APT || exit 1
        wait $PID_REPO || exit 1
        wait $PID_PY || exit 1
        
        echo "$HOME/bin" >> $GITHUB_PATH
        echo "‚úÖ Dependencias instaladas."

    - name: ‚ö° Configurar CCache
      uses: hendrikmuhs/ccache-action@v1.2.14
      with:
        max-size: "10G"

    - name: üîÑ Sincronizar C√≥digo Fuente (Repo Sync)
      run: |
        set -eo pipefail 
        trap 'echo "‚ùå ERROR DE SINCRONIZACI√ìN: Fall√≥ en la l√≠nea $LINENO." >&2' ERR
        
        mkdir -p ~/shrp && cd ~/shrp
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        echo "Iniciando Manifiesto..."
        repo init -u ${{ github.event.inputs.manifest_url }} -b ${{ github.event.inputs.manifest_branch }} --depth=1
        
        echo "ü©π Aplicando parche local para repositorios antiguos de OmniROM (Android 9.0)..."
        mkdir -p .repo/local_manifests
        cat <<EOF > .repo/local_manifests/fix_omni.xml
        <?xml version="1.0" encoding="UTF-8"?>
        <manifest>
          <remove-project name="android_frameworks_base" />
          <remove-project name="android_system_core" />
          <project path="frameworks/base" name="omnirom/android_frameworks_base_old" remote="github" revision="android-9.0" />
          <project path="system/core" name="omnirom/android_system_core_old" remote="github" revision="android-9.0" />
        </manifest>
        EOF
        
        echo "Descargando c√≥digo fuente..."
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --verbose
        
        echo "‚úÖ C√≥digo descargado correctamente."

    - name: üìÇ Clonaci√≥n Paralela (Device Tree + Vendor + Cifrado)
      run: |
        set -e
        trap 'echo "‚ùå ERROR CLONANDO REPOS: Fall√≥ en la l√≠nea $LINENO." >&2' ERR
        
        cd ~/shrp
        export GIT_TERMINAL_PROMPT=0 
        
        echo "Clonando repositorios al mismo tiempo..."
        
        # TAREA A: Device Tree
        if [ -n "${{ github.event.inputs.device_branch }}" ]; then
          git clone -b ${{ github.event.inputs.device_branch }} ${{ github.event.inputs.device_tree_url }} device/${{ github.event.inputs.device_manufacturer }}/${{ github.event.inputs.device_codename }} &
        else
          git clone ${{ github.event.inputs.device_tree_url }} device/${{ github.event.inputs.device_manufacturer }}/${{ github.event.inputs.device_codename }} &
        fi
        PID_DT=$!
        
        # TAREA B: Vendor Omni (Ajustado a Android 9.0 para SHRP v3)
        rm -rf vendor/omni
        git clone https://github.com/TeamWin/android_vendor_omni.git -b android-9.0 vendor/omni &
        PID_OMNI=$!
        
        # TAREA C: Dependencia de Cifrado (lineage-15.1 para evitar conflictos de Soong)
        mkdir -p vendor/qcom/opensource
        git clone https://github.com/LineageOS/android_vendor_qcom_opensource_cryptfs_hw.git -b lineage-15.1 vendor/qcom/opensource/cryptfs_hw &
        PID_CRYPT=$!
        
        wait $PID_DT || exit 1
        wait $PID_OMNI || exit 1
        wait $PID_CRYPT || exit 1
        
        echo "‚úÖ √Årboles, Vendors y Dependencias listos."

    - name: üî® Compilar SHRP (El Jefe Final)
      run: |
        set -e
        trap 'echo "‚ùå ERROR DE COMPILACI√ìN: El proceso fall√≥. Revisa los logs arriba." >&2' ERR
        
        cd ~/shrp
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        
        echo "ü©π Aplicando parche de emergencia en libhwbinder..."
        sed -i '1s/^/#define NATIVE_HANDLE_MAX_FDS 1024\n#define NATIVE_HANDLE_MAX_INTS 1024\n/' system/libhwbinder/Parcel.cpp || true
        
        echo "Cargando entorno de compilaci√≥n..."
        source build/envsetup.sh
        lunch omni_${{ github.event.inputs.device_codename }}-eng
        
        echo "ü©π Enga√±ando a Ninja: Creando carpeta fantasma para headers del Kernel..."
        mkdir -p out/target/product/${{ github.event.inputs.device_codename }}/obj/KERNEL_OBJ/usr
        
        echo "üî• Iniciando compilaci√≥n de ${{ github.event.inputs.build_target }}..."
        mka ${{ github.event.inputs.build_target }} -j$(nproc --all)
        echo "‚úÖ Compilaci√≥n exitosa."

    - name: üì¶ Empaquetar Archivos
      run: |
        set -e
        cd ~/shrp/out/target/product/${{ github.event.inputs.device_codename }}
        mkdir -p ~/workspace/releases
        
        # Buscamos archivos ZIP que comiencen con SHRP
        SHRP_ZIP=$(find . -maxdepth 1 -name "SHRP_*.zip" -type f | head -n 1)
        if [ -n "$SHRP_ZIP" ]; then
          cp "$SHRP_ZIP" ~/workspace/releases/
          echo "‚úÖ ZIP copiado con √©xito."
        else
          echo "‚ö†Ô∏è ADVERTENCIA: No se gener√≥ archivo ZIP de SHRP."
        fi
        
        if [ -f "recovery.img" ]; then
          cp recovery.img ~/workspace/releases/SHRP-${{ github.event.inputs.device_codename }}-recovery.img
          echo "‚úÖ Imagen .img copiada con √©xito."
        fi

    - name: ‚òÅÔ∏è Subir Archivos a GitHub
      uses: actions/upload-artifact@v4
      with:
        name: SHRP-${{ github.event.inputs.device_codename }}-Build
        path: /home/runner/workspace/releases/*

    - name: üéâ Publicar Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: SHRP-${{ github.event.inputs.device_codename }}-${{ github.run_number }}
        name: SkyHawk Recovery Project - ${{ github.event.inputs.device_codename }} (Build ${{ github.run_number }})
        files: /home/runner/workspace/releases/*
        body: |
          ## üìç Release Automatizado: SHRP
          **Dispositivo:** ${{ github.event.inputs.device_manufacturer }} ${{ github.event.inputs.device_codename }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: üö® Reporte de Falla
      if: failure()
      run: |
        echo "=========================================================="
        echo "‚ùå LA COMPILACI√ìN FALL√ì EN ALG√öN PUNTO ‚ùå"
        echo "=========================================================="
        echo "Despl√°zate hacia arriba en los logs para encontrar el error."
        echo "=========================================================="
