name: Compilar TWRP y OrangeFox Pettyl

on:
  workflow_dispatch:
    inputs:
      # --- INPUTS PARA TWRP ---
      manifest_url:
        description: 'TWRP: URL del Manifiesto'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git'
      manifest_branch:
        description: 'TWRP: Rama del Manifiesto'
        required: true
        default: 'twrp-9.0'
      device_tree_url:
        description: 'TWRP: URL del Device Tree'
        required: true
        default: 'https://github.com/elmendezz/android_device_motorola_pettyl'
      device_branch:
        description: 'TWRP: Rama del Device Tree'
        required: false
        default: 'twrp-9.0'
        
      # --- INPUTS PARA ORANGEFOX ---
      fox_sync_url:
        description: 'OrangeFox: URL del repositorio de Sincronizaci칩n'
        required: true
        default: 'https://gitlab.com/OrangeFox/sync.git'
      fox_manifest_branch:
        description: 'OrangeFox: Rama del Manifiesto (ej. 8.1, 9.0)'
        required: true
        default: '8.1'
      fox_device_tree_url:
        description: 'OrangeFox: URL del Device Tree'
        required: true
        default: 'https://github.com/elmendezz/android_device_motorola_pettyl'
      fox_device_branch:
        description: 'OrangeFox: Rama del Device Tree'
        required: false
        default: 'android-8.1'

permissions:
  contents: write

jobs:
  TWRP-Recovery-Compile:
    runs-on: ubuntu-22.04 
    
    steps:
    - name: Limpiar espacio en disco
      uses: jlumbroso/free-disk-space@v1.3.1
      with:
        tool-cache: false
        android: false

    - name: Descargar el repositorio principal
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Configurar Versi칩n TWRP (Sistema Anti-Colisi칩n)
      id: twrp_version_calc
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        SUCCESS=false
        # 1 intento inicial + 4 reintentos = 5
        for i in {1..5}; do
          # Limpiamos cualquier desastre local y bajamos la versi칩n m치s limpia del repo
          git fetch origin
          git reset --hard origin/${GITHUB_REF##*/}
          
          # Leemos la l칤nea 1 y quitamos retornos de carro fantasma o espacios
          BUILD_NUM=$(sed -n '1p' versiones.txt | tr -d '\r' | tr -d ' ')
          
          # Escudo de seguridad: Si est치 vac칤o o no es un n칰mero, usamos 0
          if ! [[ "$BUILD_NUM" =~ ^[0-9]+$ ]]; then
            echo "Aviso: L칤nea 1 estaba vac칤a o corrupta ('$BUILD_NUM'). Forzando a 0."
            BUILD_NUM=0
          fi
          
          NEW_BUILD_NUM=$((BUILD_NUM + 1))
          
          # Reemplazamos solo la l칤nea 1
          sed -i "1s/.*/$NEW_BUILD_NUM/" versiones.txt
          
          git add versiones.txt
          git commit -m "TWRP: Update build number to $NEW_BUILD_NUM" || true
          
          # Intentamos empujar
          if git push origin HEAD; then
            SUCCESS=true
            break
          else
            delay=$((RANDOM % 9 + 2)) # Aleatorio entre 2 y 10 segundos
            echo "Choque detectado con OrangeFox. Reintentando desde cero en $delay seg... (Intento $i)"
            sleep $delay
          fi
        done
        
        if [ "$SUCCESS" != "true" ]; then 
          echo "Error cr칤tico: No se pudo actualizar versiones.txt tras los reintentos."
          exit 1
        fi
        
        VERSION="3.7.0_9-0-elmendezz_build$NEW_BUILD_NUM"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "춰Versi칩n TWRP configurada como: $VERSION!"
        
    - name: Configurar Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Instalar dependencias
      run: |
        sudo apt-get update
        sudo apt-get install -y bc build-essential zip curl libc6-dev libncurses5 libncurses5-dev libssl-dev x11proto-core-dev libx11-dev libgl1-mesa-dev g++-multilib libxml2-utils xsltproc unzip python2 rsync
        
        mkdir -p $HOME/bin
        ln -s /usr/bin/python2 $HOME/bin/python
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Configurar repo y sincronizar TWRP
      run: |
        sudo curl -vL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
        sudo chmod a+rx /usr/local/bin/repo
        
        mkdir ~/twrp
        cd ~/twrp
        
        repo init --depth=1 -u ${{ github.event.inputs.manifest_url }} -b ${{ github.event.inputs.manifest_branch }}
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --verbose

    - name: Clonar 츼rbol del Dispositivo (TWRP)
      run: |
        cd ~/twrp
        if [ -n "${{ github.event.inputs.device_branch }}" ]; then
          git clone -b ${{ github.event.inputs.device_branch }} ${{ github.event.inputs.device_tree_url }} device/motorola/pettyl
        else
          git clone ${{ github.event.inputs.device_tree_url }} device/motorola/pettyl
        fi

    - name: Compilar Recovery TWRP
      run: |
        cd ~/twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        lunch omni_pettyl-eng
        make recoveryimage -j$(nproc --all)

    - name: Preparar Archivos (.img y .zip)
      run: |
        cd ~/twrp/out/target/product/pettyl/
        
        IMG_FILE="twrp-${{ env.VERSION }}-pettyl.img"
        ZIP_FILE="twrp-${{ env.VERSION }}-pettyl.zip"
        
        mv recovery.img $IMG_FILE
        zip $ZIP_FILE $IMG_FILE

    - name: Subir como Artifact de GitHub
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-${{ env.VERSION }}-pettyl
        path: |
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.img
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.zip

    - name: Publicar Release Biling칲e
      uses: softprops/action-gh-release@v2
      with:
        tag_name: twrp-${{ env.VERSION }}-pettyl
        name: TWRP ${{ env.VERSION }} - Pettyl
        files: |
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.img
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.zip
        body: |
          ## 游늸 Release: TWRP Pettyl
          **Build:** `${{ env.VERSION }}`
          
          ### 游닇 Notas de la versi칩n / Release Notes:
          - **ES:** Compilado con las 칰ltimas fuentes de TWRP para Pettyl.
          - **EN:** Compiled with the latest TWRP sources for Pettyl.
          - **ES:** Optimizado para Moto E5 Play Go Edition. Incluye versiones `.img` y `.zip`.
          - **EN:** Optimized for Moto E5 Play Go Edition. Includes `.img` and `.zip` versions.
          
          ### 游 Instalaci칩n r치pida / Quick Install:
          1. **ES:** Pon el m칩vil en modo **Fastboot** (Vol- + Power). / **EN:** Boot device into **Fastboot** mode (Vol- + Power).
          2. **PRUEBA / TEST:** `fastboot boot twrp-${{ env.VERSION }}-pettyl.img`
          3. **INSTALA / INSTALL:** `fastboot flash recovery twrp-${{ env.VERSION }}-pettyl.img`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  OrangeFox-Recovery-Compile:
    runs-on: ubuntu-22.04
    # Eliminamos el "needs: TWRP" para que corra EN PARALELO
    
    steps:
    - name: Limpiar espacio en disco
      uses: jlumbroso/free-disk-space@v1.3.1

    - name: Descargar el repositorio principal
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0 

    - name: Configurar Versi칩n OrangeFox (Sistema Anti-Colisi칩n)
      id: fox_version_calc
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        SUCCESS=false
        # 1 intento inicial + 3 reintentos = 4
        for i in {1..4}; do
          git pull --rebase origin HEAD
          
          # Leemos la l칤nea 2
          BUILD_NUM=$(sed -n '2p' versiones.txt)
          NEW_BUILD_NUM=$((BUILD_NUM + 1))
          
          # Reemplazamos solo la l칤nea 2
          sed -i "2s/.*/$NEW_BUILD_NUM/" versiones.txt
          
          git add versiones.txt
          git commit -m "OrangeFox: Update build number to $NEW_BUILD_NUM" || true
          
          if git push origin HEAD; then
            SUCCESS=true
            break
          else
            git reset --hard origin/HEAD
            delay=$((RANDOM % 3 + 10)) # Aleatorio entre 10 y 12 segundos
            echo "El Push choc칩 con TWRP. Reintentando en $delay segundos... (Intento $i de 3)"
            sleep $delay
          fi
        done
        
        if [ "$SUCCESS" != "true" ]; then 
          echo "Error cr칤tico: No se pudo actualizar versiones.txt tras 3 reintentos."
          exit 1
        fi
        
        VERSION="R11.1-elmendezz_build$NEW_BUILD_NUM"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "춰Versi칩n OrangeFox configurada como: $VERSION!"

    - name: Configurar Java 8 (Requerido para Android 8.1)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Instalar Dependencias y Configurar Python 2
      run: |
        sudo apt-get update
        sudo apt-get install -y bc build-essential zip curl libc6-dev libncurses5 libncurses5-dev libssl-dev x11proto-core-dev libx11-dev libgl1-mesa-dev g++-multilib libxml2-utils xsltproc unzip python2 rsync git ccache

        mkdir -p $HOME/bin
        ln -s /usr/bin/python2 $HOME/bin/python
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Configurar Repo Tool
      run: |
        curl https://storage.googleapis.com/git-repo-downloads/repo > $HOME/bin/repo
        chmod a+x $HOME/bin/repo

    - name: Sincronizar Fuentes (OrangeFox)
      run: |
        mkdir -p ~/OrangeFox_sync
        cd ~/OrangeFox_sync
        if [ ! -d "sync" ]; then
          git clone ${{ github.event.inputs.fox_sync_url }}
        fi
        
        cd sync/legacy
        chmod +x orangefox_sync_legacy.sh
        ./orangefox_sync_legacy.sh --branch ${{ github.event.inputs.fox_manifest_branch }} --path $HOME/fox_8.1
        
    - name: Clonar 츼rbol del Dispositivo (OrangeFox)
      run: |
        cd $HOME/fox_8.1
        if [ -n "${{ github.event.inputs.fox_device_branch }}" ]; then
          git clone -b ${{ github.event.inputs.fox_device_branch }} ${{ github.event.inputs.fox_device_tree_url }} device/motorola/pettyl
        else
          git clone ${{ github.event.inputs.fox_device_tree_url }} device/motorola/pettyl
        fi

    - name: Compilar Recovery OrangeFox
      run: |
        cd $HOME/fox_8.1
        
        export JAVA_HOME=$JAVA_HOME_8_X64
        export PATH=$JAVA_HOME/bin:$PATH
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL="C"
        
        source build/envsetup.sh
        lunch omni_pettyl-eng
        make clean
        
        mka recoveryimage FOX_VERSION="${{ env.VERSION }}" OF_MAINTAINER="elmendezz" -j$(nproc --all)

    - name: Subir como Artifact de GitHub
      uses: actions/upload-artifact@v4
      with:
        name: OrangeFox-${{ env.VERSION }}-pettyl
        path: |
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.img
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.zip

    - name: Publicar Release Biling칲e
      uses: softprops/action-gh-release@v2
      with:
        tag_name: OrangeFox-${{ env.VERSION }}-pettyl
        name: OrangeFox ${{ env.VERSION }} - Pettyl
        files: |
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.img
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.zip
        body: |
          ## 游늸 Release: OrangeFox Pettyl
          **Build:** `${{ env.VERSION }}`
          
          ### 游닇 Notas de la versi칩n / Release Notes:
          - **ES:** Compilado con las 칰ltimas fuentes de OrangeFox Legacy para Pettyl.
          - **EN:** Compiled with the latest OrangeFox Legacy sources for Pettyl.
          - **ES:** Optimizado para Moto E5 Play Go Edition.
          - **EN:** Optimized for Moto E5 Play Go Edition.
          
          ### 游 Instalaci칩n r치pida / Quick Install:
          1. **ES:** Pon el m칩vil en modo **Fastboot** (Vol- + Power). / **EN:** Boot device into **Fastboot** mode (Vol- + Power).
          2. **PRUEBA / TEST:** `fastboot boot OrangeFox-${{ env.VERSION }}-pettyl.img`
          3. **INSTALA / INSTALL:** `fastboot flash recovery OrangeFox-${{ env.VERSION }}-pettyl.img`
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
