name: Compilar TWRP y OrangeFox Pettyl

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: 'URL del Manifiesto de TWRP'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git'
      manifest_branch:
        description: 'Rama del Manifiesto de TWRP'
        required: true
        default: 'twrp-9.0'
      device_tree_url:
        description: 'URL del √Årbol del Dispositivo (Device Tree)'
        required: true
        default: 'https://github.com/elmendezz/android_device_motorola_pettyl'
      device_branch:
        description: 'Rama del Device Tree (D√©jalo en blanco si usa la rama principal)'
        required: false
        default: 'twrp-9.0'

permissions:
  contents: write

jobs:
  TWRP-Recovery-Compile:
    runs-on: ubuntu-22.04 
    
    steps:
    - name: Limpiar espacio en disco
      uses: jlumbroso/free-disk-space@v1.3.1
      with:
        tool-cache: false
        android: false

    - name: Descargar el repositorio principal
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Configurar Versi√≥n TWRP (Leer y actualizar versiones.txt)
      id: twrp_version_calc
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Leemos la l√≠nea 1
        BUILD_NUM=$(sed -n '1p' versiones.txt)
        NEW_BUILD_NUM=$((BUILD_NUM + 1))
        
        # Reemplazamos solo la l√≠nea 1
        sed -i "1s/.*/$NEW_BUILD_NUM/" versiones.txt
        
        git add versiones.txt
        git commit -m "TWRP: Update build number to $NEW_BUILD_NUM" || echo "No changes to commit"
        
        # Hacemos pull rebase por si OrangeFox modific√≥ algo al mismo tiempo
        git pull --rebase origin HEAD
        git push origin HEAD
        
        VERSION="3.7.0_9-0-elmendezz_build$NEW_BUILD_NUM"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "¬°Versi√≥n configurada como: $VERSION!"

    - name: Configurar Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Instalar dependencias
      run: |
        sudo apt-get update
        sudo apt-get install -y bc build-essential zip curl libc6-dev libncurses5 libncurses5-dev libssl-dev x11proto-core-dev libx11-dev libgl1-mesa-dev g++-multilib libxml2-utils xsltproc unzip python2 rsync
        
        mkdir -p $HOME/bin
        ln -s /usr/bin/python2 $HOME/bin/python
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Configurar repo y sincronizar TWRP
      run: |
        sudo curl -vL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
        sudo chmod a+rx /usr/local/bin/repo
        
        mkdir ~/twrp
        cd ~/twrp
        
        repo init --depth=1 -u ${{ github.event.inputs.manifest_url }} -b ${{ github.event.inputs.manifest_branch }}
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --verbose

    - name: Clonar √Årbol del Dispositivo (Pettyl)
      run: |
        cd ~/twrp
        if [ -n "${{ github.event.inputs.device_branch }}" ]; then
          git clone -b ${{ github.event.inputs.device_branch }} ${{ github.event.inputs.device_tree_url }} device/motorola/pettyl
        else
          git clone ${{ github.event.inputs.device_tree_url }} device/motorola/pettyl
        fi

    - name: Compilar Recovery TWRP
      run: |
        cd ~/twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        lunch omni_pettyl-eng
        make recoveryimage -j$(nproc --all)

    - name: Preparar Archivos (.img y .zip)
      run: |
        cd ~/twrp/out/target/product/pettyl/
        
        IMG_FILE="twrp-${{ env.VERSION }}-pettyl.img"
        ZIP_FILE="twrp-${{ env.VERSION }}-pettyl.zip"
        
        # Renombrar IMG
        mv recovery.img $IMG_FILE
        
        # Crear ZIP a partir del IMG
        zip $ZIP_FILE $IMG_FILE

    - name: Subir como Artifact de GitHub
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-${{ env.VERSION }}-pettyl
        path: |
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.img
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.zip

    - name: Publicar Release Biling√ºe
      uses: softprops/action-gh-release@v2
      with:
        tag_name: twrp-${{ env.VERSION }}-pettyl
        name: TWRP ${{ env.VERSION }} - Pettyl
        files: |
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.img
          /home/runner/twrp/out/target/product/pettyl/twrp-${{ env.VERSION }}-pettyl.zip
        body: |
          ## üìç Release: TWRP Pettyl
          **Build:** `${{ env.VERSION }}`
          
          ### üìù Notas de la versi√≥n / Release Notes:
          - **ES:** Compilado con las √∫ltimas fuentes de TWRP para Pettyl.
          - **EN:** Compiled with the latest TWRP sources for Pettyl.
          - **ES:** Optimizado para Moto E5 Play Go Edition. Incluye versiones `.img` y `.zip`.
          - **EN:** Optimized for Moto E5 Play Go Edition. Includes `.img` and `.zip` versions.
          
          ### üöÄ Instalaci√≥n r√°pida / Quick Install:
          1. **ES:** Pon el m√≥vil en modo **Fastboot** (Vol- + Power). / **EN:** Boot device into **Fastboot** mode (Vol- + Power).
          2. **PRUEBA / TEST:** `fastboot boot twrp-${{ env.VERSION }}-pettyl.img`
          3. **INSTALA / INSTALL:** `fastboot flash recovery twrp-${{ env.VERSION }}-pettyl.img`
          
          ### üîå La Regla de Oro / The Golden Rule:
          - **ES:** Olv√≠date de la bater√≠a. **LO QUE IMPORTA ES EL CABLE.** Aseg√∫rate de que la conexi√≥n USB sea s√≥lida como una roca. Un cable que se desconecta es el enemigo n√∫mero uno de un buen flash.
          - **EN:** Forget about the battery. **THE CABLE IS WHAT MATTERS.** Make sure your USB connection is rock solid. A disconnecting cable is the number one enemy of a good flash.
          
          ### üÜò ¬øNo funciona? / Not working?:
          - **ES:** Si el recovery no inicia o no es para tu modelo, **abre un Issue** en el repositorio.
          - **EN:** If the recovery doesn't boot or isn't for your model, **open an Issue** in the repository.
          
          **¬°Disfr√∫talo! / Enjoy!**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


  OrangeFox-Recovery-Compile:
    runs-on: ubuntu-22.04
    # Para evitar que se pisen los cambios de versiones.txt, le decimos que espere a TWRP
    needs: TWRP-Recovery-Compile
    
    steps:
    - name: Limpiar espacio en disco
      uses: jlumbroso/free-disk-space@v1.3.1

    - name: Descargar el repositorio principal
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        # Obtenemos los √∫ltimos cambios (el commit que acaba de hacer TWRP)
        fetch-depth: 0 

    - name: Configurar Versi√≥n OrangeFox (Leer y actualizar versiones.txt)
      id: fox_version_calc
      run: |
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Tiramos del c√≥digo m√°s reciente por precauci√≥n
        git pull --rebase origin HEAD
        
        # Leemos la l√≠nea 2
        BUILD_NUM=$(sed -n '2p' versiones.txt)
        NEW_BUILD_NUM=$((BUILD_NUM + 1))
        
        # Reemplazamos solo la l√≠nea 2
        sed -i "2s/.*/$NEW_BUILD_NUM/" versiones.txt
        
        git add versiones.txt
        git commit -m "OrangeFox: Update build number to $NEW_BUILD_NUM" || echo "No changes to commit"
        git push origin HEAD
        
        VERSION="R11.1-elmendezz_build$NEW_BUILD_NUM"
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        echo "¬°Versi√≥n configurada como: $VERSION!"

    - name: Configurar Java 8 (Requerido para Android 8.1)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Instalar Dependencias y Configurar Python 2
      run: |
        sudo apt-get update
        sudo apt-get install -y bc build-essential zip curl libc6-dev libncurses5 libncurses5-dev libssl-dev x11proto-core-dev libx11-dev libgl1-mesa-dev g++-multilib libxml2-utils xsltproc unzip python2 rsync git ccache

        mkdir -p $HOME/bin
        ln -s /usr/bin/python2 $HOME/bin/python
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Configurar Repo Tool
      run: |
        curl https://storage.googleapis.com/git-repo-downloads/repo > $HOME/bin/repo
        chmod a+x $HOME/bin/repo

    - name: Sincronizar Fuentes (M√©todo Legacy 8.1)
      run: |
        mkdir -p ~/OrangeFox_sync
        cd ~/OrangeFox_sync
        if [ ! -d "sync" ]; then
          git clone https://gitlab.com/OrangeFox/sync.git
        fi
        
        cd sync/legacy
        chmod +x orangefox_sync_legacy.sh
        ./orangefox_sync_legacy.sh --branch 8.1 --path $HOME/fox_8.1
        
    - name: Clonar Device Tree
      run: |
        cd $HOME/fox_8.1
        git clone https://github.com/elmendezz/android_device_motorola_pettyl -b android-8.1 device/motorola/pettyl

    - name: Compilar Recovery OrangeFox
      run: |
        cd $HOME/fox_8.1
        
        export JAVA_HOME=$JAVA_HOME_8_X64
        export PATH=$JAVA_HOME/bin:$PATH
        export ALLOW_MISSING_DEPENDENCIES=true
        export LC_ALL="C"
        
        source build/envsetup.sh
        lunch omni_pettyl-eng
        make clean
        
        # Pasamos la variable din√°mica que creamos en el paso de git
        mka recoveryimage FOX_VERSION="${{ env.VERSION }}" OF_MAINTAINER="elmendezz" -j$(nproc --all)

    - name: Subir como Artifact de GitHub
      uses: actions/upload-artifact@v4
      with:
        name: OrangeFox-${{ env.VERSION }}-pettyl
        path: |
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.img
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.zip

    - name: Publicar Release Biling√ºe
      uses: softprops/action-gh-release@v2
      with:
        tag_name: OrangeFox-${{ env.VERSION }}-pettyl
        name: OrangeFox ${{ env.VERSION }} - Pettyl
        files: |
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.img
          /home/runner/fox_8.1/out/target/product/pettyl/OrangeFox-*-pettyl.zip
        body: |
          ## üìç Release: OrangeFox Pettyl
          **Build:** `${{ env.VERSION }}`
          
          ### üìù Notas de la versi√≥n / Release Notes:
          - **ES:** Compilado con las √∫ltimas fuentes de TWRP y OrangeFox Legacy para Pettyl.
          - **EN:** Compiled with the latest TWRP and OrangeFox Legacy sources for Pettyl.
          - **ES:** Optimizado para Moto E5 Play Go Edition.
          - **EN:** Optimized for Moto E5 Play Go Edition.
          
          ### üöÄ Instalaci√≥n r√°pida / Quick Install:
          1. **ES:** Pon el m√≥vil en modo **Fastboot** (Vol- + Power). / **EN:** Boot device into **Fastboot** mode (Vol- + Power).
          2. **PRUEBA / TEST:** `fastboot boot OrangeFox-${{ env.VERSION }}-pettyl.img`
          3. **INSTALA / INSTALL:** `fastboot flash recovery OrangeFox-${{ env.VERSION }}-pettyl.img`
          
          ### üîå La Regla de Oro / The Golden Rule:
          - **ES:** Olv√≠date de la bater√≠a. **LO QUE IMPORTA ES EL CABLE.** Aseg√∫rate de que la conexi√≥n USB sea s√≥lida como una roca. Un cable que se desconecta es el enemigo n√∫mero uno de un buen flash.
          - **EN:** Forget about the battery. **THE CABLE IS WHAT MATTERS.** Make sure your USB connection is rock solid. A disconnecting cable is the number one enemy of a good flash.
          
          ### üÜò ¬øNo funciona? / Not working?:
          - **ES:** Si el recovery no inicia o no es para tu modelo, **abre un Issue** en el repositorio.
          - **EN:** If the recovery doesn't boot or isn't for your model, **open an Issue** in the repository.
          
          **¬°Disfr√∫talo! / Enjoy!**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
