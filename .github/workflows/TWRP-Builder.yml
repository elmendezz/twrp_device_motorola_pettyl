name: Compilar TWRP Pettyl - Mod

on:
  workflow_dispatch:
    inputs:
      manifest_url:
        description: 'URL del Manifiesto de TWRP'
        required: true
        default: 'https://github.com/minimal-manifest-twrp/platform_manifest_twrp_omni.git'
      manifest_branch:
        description: 'Rama del Manifiesto de TWRP'
        required: true
        default: 'twrp-9.1'
      device_tree_url:
        description: 'URL del rbol del Dispositivo (Device Tree)'
        required: true
        default: 'https://github.com/elmendezz/android_device_motorola_pettyl'
      device_branch:
        description: 'Rama del Device Tree (D茅jalo en blanco si usa la rama principal)'
        required: false
        default: 'twrp-9.0'

# PERMISO VITAL para que GitHub Actions pueda publicar un "Release"
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04 
    
    steps:
    - name: Limpiar espacio en disco
      uses: jlumbroso/free-disk-space@v1.3.1
      with:
        tool-cache: false
        android: false

    - name: Configurar entorno
      uses: actions/checkout@v4

    - name: Configurar Java 8
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '8'

    - name: Instalar dependencias
      run: |
        sudo apt-get update
        sudo apt-get install -y bc build-essential zip curl libc6-dev libncurses5 libncurses5-dev libssl-dev x11proto-core-dev libx11-dev libgl1-mesa-dev g++-multilib libxml2-utils xsltproc unzip python2 rsync
        
        # Enga帽amos al PATH para que 'python' abra Python 2
        mkdir -p $HOME/bin
        ln -s /usr/bin/python2 $HOME/bin/python
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Configurar repo y sincronizar TWRP
      run: |
        sudo curl -vL https://storage.googleapis.com/git-repo-downloads/repo -o /usr/local/bin/repo
        sudo chmod a+rx /usr/local/bin/repo
        
        mkdir ~/twrp
        cd ~/twrp
        
        git config --global user.name "GitHub Action"
        git config --global user.email "action@github.com"
        
        # Usamos las variables inyectadas por el men煤 de GitHub (inputs)
        repo init --depth=1 -u ${{ github.event.inputs.manifest_url }} -b ${{ github.event.inputs.manifest_branch }}
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --verbose

    - name: Clonar rbol del Dispositivo (Pettyl)
      run: |
        cd ~/twrp
        # L贸gica para clonar con o sin rama espec铆fica dependiendo de lo que pongas en el men煤
        if [ -n "${{ github.event.inputs.device_branch }}" ]; then
          git clone -b ${{ github.event.inputs.device_branch }} ${{ github.event.inputs.device_tree_url }} device/motorola/pettyl
        else
          git clone ${{ github.event.inputs.device_tree_url }} device/motorola/pettyl
        fi

    - name: Compilar Recovery
      run: |
        cd ~/twrp
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        lunch omni_pettyl-eng
        make recoveryimage -j$(nproc --all)

    - name: Extraer versi贸n de TWRP y Preparar Archivos
      id: twrp_version
      run: |
        cd ~/twrp
        # Configuramos la versi贸n detectada
        VERSION="3.7.0_9-0"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Versi贸n configurada: $VERSION"
        
        # Renombramos el archivo recovery.img con la versi贸n para el Release
        mv out/target/product/pettyl/recovery.img out/target/product/pettyl/twrp-${VERSION}-pettyl.img

    - name: Publicar Release Biling眉e
      uses: softprops/action-gh-release@v2
      with:
        tag_name: twrp-${{ steps.twrp_version.outputs.version }}-pettyl
        name: TWRP ${{ steps.twrp_version.outputs.version }} - Pettyl
        # Usamos la ruta absoluta para que GitHub Actions encuentre el archivo sin problemas
        files: /home/runner/twrp/out/target/product/pettyl/twrp-${{ steps.twrp_version.outputs.version }}-pettyl.img
        body: |
          ##  Release: TWRP Pettyl
          
          ###  Notas de la versi贸n / Release Notes:
          - **ES:** Compilado con las 煤ltimas fuentes de TWRP para Pettyl.
          - **EN:** Compiled with the latest TWRP sources for Pettyl.
          - **ES:** Optimizado para Moto E5 Play Go Edition.
          - **EN:** Optimized for Moto E5 Play Go Edition.
          
          ###  Instalaci贸n r谩pida / Quick Install:
          1. **ES:** Pon el m贸vil en modo **Fastboot** (Vol- + Power). / **EN:** Boot device into **Fastboot** mode (Vol- + Power).
          2. **PRUEBA / TEST:** `fastboot boot twrp-${{ steps.twrp_version.outputs.version }}-pettyl.img`
          3. **INSTALA / INSTALL:** `fastboot flash recovery twrp-${{ steps.twrp_version.outputs.version }}-pettyl.img`
          
          ###  La Regla de Oro / The Golden Rule:
          - **ES:** Olv铆date de la bater铆a. **LO QUE IMPORTA ES EL CABLE.** Aseg煤rate de que la conexi贸n USB sea s贸lida como una roca. Un cable que se desconecta es el enemigo n煤mero uno de un buen flash.
          - **EN:** Forget about the battery. **THE CABLE IS WHAT MATTERS.** Make sure your USB connection is rock solid. A disconnecting cable is the number one enemy of a good flash.
          
          ###  驴No funciona? / Not working?:
          - **ES:** Si el recovery no inicia o no es para tu modelo, **abre un Issue** en el repositorio. Por favor, detalla tu variante del tel茅fono. Si solo dices "no sirve", no podr茅 ayudarte a que sirva. 
          - **EN:** If the recovery doesn't boot or isn't for your model, **open an Issue** in the repository. Please detail your phone variant. If you just say "it doesn't work", I won't be able to help you fix it.
          
          **隆Disfr煤talo! / Enjoy!**
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
